#include "prosystem.h"
//#include "multisprite.h"


#define multisprite_color(color) ((color >= 0xf0)?(0x20 + (color & 0x0f)):((color)))


reversed scattered(16,32) char tiles[512] = {
	0x55, 0x55, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x65, 0x55, 0xff, 0xcb, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x55, 0xff, 0xcb, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x55, 0xaa, 0x8a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x55, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x59, 0xf2, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x55, 0xf2, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x59, 0x55, 0xa2, 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x55, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x55, 0xff, 0xcb, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x95, 0xff, 0xcb, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x55, 0xaa, 0x8a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x55, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x55, 0xf2, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x55, 0xf2, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x56, 0xa2, 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

reversed scattered(16,32) char mask[512] = {
	0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x54, 0x55, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x54, 0x55, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x54, 0x55, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x54, 0x55, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x58, 0x95, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x68, 0xa5, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0xb8, 0xa9, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x3a, 0xa1, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x0a, 0x81, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x02, 0x01, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x42, 0x05, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x52, 0x15, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x54, 0x55, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
	0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa
};

#define ROW_WIDTH 43
#define COL_LIMIT 22
const char tilemap[1290] = {
2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,
2,0,0,2,2,0,2,2,2,0,2,0,0,2,0,2,2,2,0,2,2,0,0,0,2,0,0,2,2,2,0,2,0,0,2,0,0,2,0,0,2,0,2,
2,0,2,0,0,0,2,0,0,0,2,2,0,2,0,2,0,0,0,2,0,2,0,2,0,2,0,0,2,0,0,2,0,2,0,2,0,2,2,0,2,0,2,
2,0,2,0,2,0,2,2,0,0,2,0,2,2,0,2,2,0,0,2,2,0,0,2,2,2,0,0,2,0,0,2,0,2,0,2,0,2,0,2,2,0,2,
2,0,2,0,2,0,2,0,0,0,2,0,0,2,0,2,0,0,0,2,0,2,0,2,0,2,0,0,2,0,0,2,0,2,0,2,0,2,0,0,2,0,2,
2,0,0,2,2,0,2,2,2,0,2,0,0,2,0,2,2,2,0,2,0,2,0,2,0,2,0,0,2,0,0,2,0,0,2,0,0,2,0,0,2,0,2,
2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,2,0,0,0,2,0,2,2,2,0,0,2,2,0,0,2,2,2,0,0,0,2,2,0,0,0,2,2,2,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,2,2,0,2,2,0,0,2,0,0,2,0,0,2,0,2,0,0,2,0,2,0,0,2,0,2,0,0,0,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,2,0,2,0,2,0,0,2,0,0,2,0,0,0,0,2,2,2,0,0,2,0,0,2,0,0,2,2,0,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,2,0,0,0,2,0,0,2,0,0,2,0,0,2,0,2,0,0,2,0,2,0,0,2,0,0,0,0,2,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,2,0,0,0,2,0,2,2,2,0,0,2,2,0,0,2,0,0,2,0,0,2,2,0,0,2,2,2,0,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,
2,0,0,2,2,0,2,2,2,0,2,0,0,2,0,2,2,2,0,2,2,0,0,0,2,0,0,2,2,2,0,2,0,0,2,0,0,2,0,0,2,0,2,
2,0,2,0,0,0,2,0,0,0,2,2,0,2,0,2,0,0,0,2,0,2,0,2,0,2,0,0,2,0,0,2,0,2,0,2,0,2,2,0,2,0,2,
2,0,2,0,2,0,2,2,0,0,2,0,2,2,0,2,2,0,0,2,2,0,0,2,2,2,0,0,2,0,0,2,0,2,0,2,0,2,0,2,2,0,2,
2,0,2,0,2,0,2,0,0,0,2,0,0,2,0,2,0,0,0,2,0,2,0,2,0,2,0,0,2,0,0,2,0,2,0,2,0,2,0,0,2,0,2,
2,0,0,2,2,0,2,2,2,0,2,0,0,2,0,2,2,2,0,2,0,2,0,2,0,2,0,0,2,0,0,2,0,0,2,0,0,2,0,0,2,0,2,
2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,2,0,0,0,2,0,2,2,2,0,0,2,2,0,0,2,2,2,0,0,0,2,2,0,0,0,2,2,2,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,2,2,0,2,2,0,0,2,0,0,2,0,0,2,0,2,0,0,2,0,2,0,0,2,0,2,0,0,0,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,2,0,2,0,2,0,0,2,0,0,2,0,0,0,0,2,2,2,0,0,2,0,0,2,0,0,2,2,0,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,2,0,0,0,2,0,0,2,0,0,2,0,0,2,0,2,0,0,2,0,2,0,0,2,0,0,0,0,2,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,2,0,0,0,2,0,2,2,2,0,0,2,2,0,0,2,0,0,2,0,0,2,2,0,0,2,2,2,0,0,0,0,0,0,0,2,
2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,
2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2
};

#define DLL_ARRAY_SIZE 16
ramchip unsigned char dll[64];
ramchip unsigned char dl0[192];
ramchip unsigned char dl_empty[2];

#include "joystick.h"

unsigned char tanx, tany, tmp, tmp2, delay, row, col, i;
signed char tandx, tandy;
char sprite_x, sprite_y;
unsigned char *tilemap_ptr, *ptr, mask_ptr;

void init_dll() {
	tmp = 0;
	for (i=0; i<1; i++) {
		dll[tmp++] = 0x47;
		dll[tmp++] = dl_empty >> 8;
		dll[tmp++] = dl_empty;
	}
	tilemap_ptr = dl0;
	for (i=0; i<DLL_ARRAY_SIZE; i++) {
		dll[tmp++] = 0x4F;
		dll[tmp++] = tilemap_ptr >> 8;
		dll[tmp++] = tilemap_ptr;
		tilemap_ptr += 7;
	}
	for (i=0; i<2; i++) {
		dll[tmp++] = 0x4F;
		dll[tmp++] = dl_empty >> 8;
		dll[tmp++] = dl_empty;
	}
	dll[tmp++] = 0;
	dll[tmp++] = 0;
	dll[tmp++] = 0;
	dll[tmp++] = 0;
	dll[tmp++] = 0;
	dll[tmp++] = 0;

	tmp = 0;
	tilemap_ptr = tilemap;
	for (i=0; i<DLL_ARRAY_SIZE; i++) {
		dl0[tmp++] = tilemap_ptr;
		dl0[tmp++] = 0x60;
		dl0[tmp++] = tilemap_ptr >> 8;
		dl0[tmp++] = 11;
		dl0[tmp++] = 0;

		dl0[tmp++] = 0;	// End of DL
		dl0[tmp++] = 0;
		tilemap_ptr += ROW_WIDTH;
	}

	dl_empty[0] = 0;
	dl_empty[1] = 0;
	tilemap_ptr = tilemap;
	mask_ptr = mask+6;
}

void main()
{
	init_dll();
    while (!(*MSTAT < 0)); // Wait for VBLANK
    while (*MSTAT < 0); // Wait for end of VBLANK

    X = 0;
    do {
        strobe(WSYNC);
        strobe(WSYNC);
        X++;
    } while (!(*MSTAT & 0x80));


   	// Background palette
    *BACKGRND = 0x00;					// Tiles
    *P0C1 = 148;
    *P0C2 = 6;
    *P0C3 = 10;

    *P1C1 = multisprite_color(0x35);	// logo 1
    *P1C2 = multisprite_color(0x0f);
    *P1C3 = multisprite_color(0xff);

    *P2C1 = multisprite_color(0x0f);	// logo 2
    *P2C2 = multisprite_color(0x35);
    *P2C3 = multisprite_color(0xff);

    *P3C1 = multisprite_color(0x0f);	// logo 3
    *P3C2 = multisprite_color(0xff);
    *P3C3 = multisprite_color(0x35);

    *P4C1 = multisprite_color(0x95);	// Sprite body
    *P4C2 = multisprite_color(0x3c);
    *P4C3 = multisprite_color(0x3c);

    *P5C1 = multisprite_color(0xf5);	// Cup
    *P5C2 = multisprite_color(0xf8);
    *P5C3 = multisprite_color(0xfe);

    *P6C1 = multisprite_color(0xc7);
    *P6C2 = multisprite_color(0xfd);
    *P6C3 = multisprite_color(0xfe);

    *P7C1 = multisprite_color(0x0f);	// Francois head
    *P7C2 = multisprite_color(0x00);
    *P7C3 = multisprite_color(0x3c);


	*CHARBASE = (tiles) >> 8;
	*DPPH = dll >> 8; // 1 the current displayed buffer
	*DPPL = dll;
	*CTRL = 0x50;

    delay = 0;
	sprite_x = 0;
	sprite_y = 15;
	row = 0;
	col = 0;

    // Main loop
    do {
		while (!(*MSTAT < 0));
        joystick_update();

		if (delay != 16) {
			delay++;
			continue;
		}

		delay = 0;
        if (joystick[0] & JOYSTICK_DOWN) {
            if (sprite_y != 0) {
                sprite_y--;
				dll[3] = 0x40 | sprite_y;
				mask_ptr -= 256;
            } else {
				if (row != 15) {
					sprite_y = 15;
					row++;
					dll[3] = 0x4F;
					tilemap_ptr += ROW_WIDTH;
					ptr = tilemap_ptr;
					tmp = 0;
					for (i=0; i<DLL_ARRAY_SIZE; i++) {
						dl0[tmp] = ptr;
						tmp += 2;
						dl0[tmp] = ptr >> 8;
						ptr += ROW_WIDTH;
						tmp += 5;
					}
				}
			}
        } else if ((joystick[0] & JOYSTICK_UP)) {
            if (sprite_y != 15) {
                sprite_y++;
				dll[3] = 0x40 | sprite_y;
				mask_ptr -= 256;
            } else {
				if (row) {
					sprite_y = 0;
					tilemap_ptr -= ROW_WIDTH;
					row--;
					dll[3] = 0x40;
					ptr = tilemap_ptr;
					tmp = 0;
					for (i=0; i<DLL_ARRAY_SIZE; i++) {
						dl0[tmp] = ptr;
						tmp += 2;
						dl0[tmp] = ptr >> 8;
						ptr += ROW_WIDTH;
						tmp += 5;
					}
				}
			}
		}
        if (joystick[0] & JOYSTICK_RIGHT) {
            if (sprite_x != -7) {
                sprite_x--;
            } else {
				if (col != COL_LIMIT) {
					sprite_x = 0;
					col++;
					tilemap_ptr++;
					ptr = tilemap_ptr;
					tmp = 0;
					for (i=0; i<DLL_ARRAY_SIZE; i++) {
						dl0[tmp] = ptr;
						tmp += 2;
						dl0[tmp] = ptr >> 8;
						ptr += ROW_WIDTH;
						tmp += 5;
					}
				}
			}
			dl0[4] = sprite_x;
			dl0[11] = sprite_x;
			dl0[18] = sprite_x;
			dl0[25] = sprite_x;
			dl0[32] = sprite_x;
			dl0[39] = sprite_x;
			dl0[46] = sprite_x;
			dl0[53] = sprite_x;
			dl0[60] = sprite_x;
			dl0[67] = sprite_x;
			dl0[74] = sprite_x;
			dl0[81] = sprite_x;
			dl0[88] = sprite_x;
			dl0[95] = sprite_x;
			dl0[102] = sprite_x;
			dl0[109] = sprite_x;
        } else if ((joystick[0] & JOYSTICK_LEFT)) {
            if (sprite_x != 0) {
                sprite_x++;
            } else {
				if (col) {
					sprite_x = -7;
					col--;
					tilemap_ptr--;
					ptr = tilemap_ptr;
					tmp = 0;
					for (i=0; i<DLL_ARRAY_SIZE; i++) {
						dl0[tmp] = ptr;
						tmp += 2;
						dl0[tmp] = ptr >> 8;
						ptr += ROW_WIDTH;
						tmp += 5;
					}
				}
			}
			dl0[4] = sprite_x;
			dl0[11] = sprite_x;
			dl0[18] = sprite_x;
			dl0[25] = sprite_x;
			dl0[32] = sprite_x;
			dl0[39] = sprite_x;
			dl0[46] = sprite_x;
			dl0[53] = sprite_x;
			dl0[60] = sprite_x;
			dl0[67] = sprite_x;
			dl0[74] = sprite_x;
			dl0[81] = sprite_x;
			dl0[88] = sprite_x;
			dl0[95] = sprite_x;		
			dl0[102] = sprite_x;
			dl0[109] = sprite_x;
        }

    } while(1);
}
